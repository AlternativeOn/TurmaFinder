<!DOCTYPE html>
<html>

<head>
    <title>Turma Finder</title>
    <meta name="author" content="Alternative On">
    <meta name="theme-color" content="#0061fb">
    <meta name="url" content="https://turma.princessmortix.link">
    <meta name="og:url" content="https://turma.princessmortix.link">
    <meta name="og:see_also" content="https://turma.princessmortix.link">
    <meta name="twitter:url" content="https://turma.princessmortix.link">
    <meta name="og:site_name" content="turma.princessmortix.link">
    <meta name="name" content="Encontre sua turma!">
    <meta name="og:title" content="Encontre sua turma!">
    <meta name="twitter:title" content="Encontre sua turma!">
    <meta name="description"
        content="TurmaFinder √© um site da internet que te ajuda a encontra a sua turma pelo Positivo On.">
    <meta name="og:description"
        content="TurmaFinder √© um site da internet que te ajuda a encontra a sua turma pelo Positivo On.">
    <meta name="twitter:description"
        content="TurmaFinder √© um site da internet que te ajuda a encontra a sua turma pelo Positivo On.">
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap');

        * {
            font-family: 'Noto Sans';
        }

        body {
            background-image: linear-gradient(90deg, #776BCC 0%, #C7C5F4 100%);
            background-size: 400% 400%;
            -webkit-animation: gradient 40s ease infinite;
            animation: gradient 40s ease infinite;
        }

        @keyframes gradient {
            0% {
                background-position: 0% 50%;
            }
             50% {
                background-position: 100% 50%;
             }
            100% {
                background-position: 0% 50%;
            }
        }

        .loginbox {
            margin: auto;
            width: 50%;
            border: 2px solid grey;
            padding: 2%;
            background: linear-gradient(45deg, #C7C5F4, #776BCC);
            background-size: 400% 400%;
            -webkit-animation: gradient 40s ease infinite;
            animation: gradient 40s ease infinite;
            border-radius: 25px;
            transform: translate(-50%, -50%);
            left: 50%;
            top: 50%;
            position: absolute;
        }



        .loginfield {
            padding: 20px 0px;
            position: relative;
        }

        .logininput {
            border: none;
            border-bottom: 2px solid #D1D1D4;
            background: none;
            padding: 10px;
            padding-left: 24px;
            font-weight: 700;
            width: 90%;
            transition: .2s;
        }

        .logininput:active,
        .logininput:focus,
        .logininput:hover {
            outline: none;
            border-bottom-color: #6A679E;
        }

        .logingo {
            background: #fff;
            font-size: 14px;
            padding: 16px 20px;
            border-radius: 26px;
            border: 1px solid #D4D3E8;
            text-transform: uppercase;
            font-weight: 700;
            display: block;
            align-items: center;
            width: 100%;
            color: #4C489D;
            box-shadow: 0px 2px 2px #5C5696;
            cursor: pointer;
            transition: .2s;
        }

        .feather {
            position: absolute;
            top: 30px;
            color: #776BCC;
            width: 20px;
            height: 20px;
        }

        .footer {
            font-size: 12px;
            text-align: center;
        }
        a, a:visited, a:link {
                text-decoration: none;
                color: slateblue;
        }

        .error {
            color: red;
            font-size: 18px;
        }
    </style>
</head>

<body>
    <div class="loginbox" id="messagecontrol">
        <h2 id="msgtitle">Fa√ßa seu login</h2>
        <p id="msginfo">Assim voc√™ pode saber em qual turma voc√™ est√° em 2024.</p>
        <form class="loginform" id="form">
            <div class="loginfield">
                <i data-feather="user"></i>
                <input type="text" class="logininput" placeholder="Usu√°rio do Positivo On" required id="username">
            </div>
            <div class="loginfield">
                <i data-feather="key" ></i>
                <input type="password" class="logininput" placeholder="Senha do Positivo On" required id="password">
            </div>
        </form>
        <button class="logingo" onclick="login()" id="btn">Ver minha turma!</button>
        <p class="footer">AlternativeOn // <a href="https://github.com/AlternativeOn/TurmaFinder/tree/web?tab=readme-ov-file#como-funciona" target="_blank">Como funciona?</a></p>
    </div>

    <script>
        feather.replace();
        var msgc = document.getElementById("form");
        var msg = document.getElementById("msgtitle");
        var detailmsg = document.getElementById("msginfo");
        var btnmsg = document.getElementById("btn");
        var username = document.getElementById("username");
        var password = document.getElementById("password");

        async function login() {
            if (username.value == "" || password.value == "") {
                detailmsg.innerHTML += "<p class='error'>O usu√°rio e/ou senha est√£o em branco!</p>"
                return
            }
            

            var reqHeaders = new Headers();

            reqHeaders.append("Content-Type", "application/json");


            var raw = JSON.stringify({
                "username": username.value,
                "password": password.value,
                "realm": "eem"
            });

            var requestOptions = {
                method: 'POST',
                headers: reqHeaders,
                body: raw,
                redirect: 'follow',
            };

            msgc.style.display = "none";
            msg.innerText = "Carregando...";
            detailmsg.innerText = "Aguarde um curto momento";
            btnmsg.style.display = "none";


            const response = await fetch("https://proxy-turma-finder.princessmortix.workers.dev/https://portal-bff.positivoon.com.br/login", requestOptions)
            .catch(error => wentWrong(error))
            if (!response.ok) {
                wentWrong(response.statusText)
            }
            

            const result = await response.json();
            console.log("sucess:", result);

            var pal = result.accounts.length - 1;
            var cls = result.accounts[pal].classrooms.length - 1;
            var turma = result.accounts[pal].classrooms[cls].classroom.name.toString().substring(2);
            var nomeAlto = result.firstName.split(" ")[0];
            var nomeBaixo = nomeAlto.toLowerCase();
            var nome = nomeBaixo.charAt(0).toUpperCase() + nomeBaixo.slice(1);

            msg.innerText = "Voc√™ ser√° da turma " + turma + ","
            detailmsg.innerText = "de acordo com a ultima atualiza√ß√£o do Positivo On. √â possivel que esse valor n√£o tenha sido ainda alterado.\n" + `Boa sorte nos estudos, ${nome}! üëã`
        }
        

        function wentWrong(detailError) {
            msgc.style.display = "none";
            msg.innerText = "Algo deu errado!";
            detailmsg.innerText = "Verifique se o usu√°rio e senha est√° corretos, e tente novamente.\nDetalhe do erro: " + detailError;
            btnmsg.innerText = "Tentar novamente...";
            btnmsg.innerHTML = "<button class='logingo' onclick='location.reload()'>Tentar de novo</button>"
        }
    </script>
</body>

</html>
